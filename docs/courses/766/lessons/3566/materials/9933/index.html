<!-- Generated by https://github.com/rodion-gudz/YandexLyceumDocs -->

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Учебник | Работа с протоколом HTTP </title>
    <link rel="stylesheet" href="/css/client.css"/>
	<link rel="stylesheet" href="/css/material.css">
	<link rel="stylesheet" href="/css/prism.css"/>
</head>
<body>
	<div class="lesson-material">
		<div class="layout">
			<div class="layout__wrapper layout__wrapper_type_narrow layout__wrapper_fixed">
				<main class="layout__main">
					<div class="lesson-material__wrapper">
						<a class="nav-tab nav-tab_back nav-tab_view_button" href="../..">
						<span data-lego="react"
						      class="icon icon_type_arrow-short icon_direction_left icon_size_s nav-tab__arrow-icon"></span>
							<span class="nav-tab__inner">Урок WEB 6</span>
						</a>
						<section class="lesson-material__content">
							<article class="material"><h1>Работа с&nbsp;протоколом HTTP</h1>
<section class="material__plan"><nav>
<ol>
<li><a class="material__link" href="#1">Повторение</a></li>
<li><a class="material__link" href="#2">Задание параметров url</a></li>
<li><a class="material__link" href="#3">Поисковое приложение</a></li>
<li><a class="material__link" href="#4">API Поиска по&nbsp;организациям</a></li>
<li><a class="material__link" href="#5">Еще немного о&nbsp;возможностях requests</a></li>
</ol>
</nav></section>
<section class="material__annotation">
<h2>Аннотация</h2>
<p>В&nbsp;уроке продолжается рассказ про использование HTTP-API. Показан пример поискового приложения, формирующего запросы к&nbsp;HTTP-API на&nbsp;основании результатов других запросов. Рассматривается API поиска по&nbsp;организациям с&nbsp;примерами задач.</p>
</section>
<section class="material__chapter">
<h2 id="1">Повторение</h2>
<p>На&nbsp;одном из&nbsp;прошлых уроков мы&nbsp;начали разговор о&nbsp;разных видах API. Практическую часть мы&nbsp;посвятили использованию HTTP-API на&nbsp;примере Yandex.Maps.StaticAPI и&nbsp;Yandex.Maps.Geocoder. Давайте вспомним, как выглядит это взаимодействие с&nbsp;точки зрения Python-приложения.</p>
</section>
<section class="material__chapter">
<h2 id="2">Задание параметров url</h2>
<p>В&nbsp;наших примерах запрос к&nbsp;API был представлен константной строкой, поскольку этого достаточно для первого знакомства с&nbsp;возможностями API. В&nbsp;более сложных задачах запрос приходится формировать в&nbsp;ходе выполнения программы, основываясь на&nbsp;данных, введенных пользователем или полученных иным образом. Делать это путем конкатенации строк или каким-то подобным образом крайне неудобно (это будет работать, но&nbsp;мы&nbsp;настоятельно не&nbsp;рекомендуем так делать) и&nbsp;порождает километровые строки в&nbsp;коде программы. К&nbsp;тому&nbsp;же надо решать вопросы с&nbsp;кодированием различных специальных символов. Про кодирование url-запросов (замены пробелов на &laquo;+&raquo;, %-кодирование) можно прочитать <a class="material__link" href="https://ru.wikipedia.org/wiki/URL#Кодирование_URL" target="_blank" rel="noopener noreferrer">в&nbsp;Википедии</a>.</p>
<p>Разумеется, есть и&nbsp;более удобный способ. Для удобства формирования запросов в&nbsp;функциях <code>requests.request()</code> и&nbsp;<code>requests.get()</code> есть именованный параметр <var>params</var>, представляющий собой словарь (dict). В&nbsp;нем содержится отображение из&nbsp;названий параметров в&nbsp;их&nbsp;значения. Давайте рассмотрим пример из&nbsp;предыдущей лекции:</p>
<pre><code class="language-python">map_request = "http://static-maps.yandex.ru/1.x/?ll=37.530887,55.703118&amp;spn=0.002,0.002&amp;l=map"
response = requests.get(map_request)
</code></pre>
<p>Этот код можно переписать вот так:</p>
<pre><code class="language-python">import requests
api_server = "http://static-maps.yandex.ru/1.x/"

lon = "37.530887"
lat = "55.703118"
delta = "0.002"

params = {
    "ll": ",".join([lon, lat]),
    "spn": ",".join([delta, delta]),
    "l": "map"
}
response = requests.get(api_server, params=params)
</code></pre>
<p>Результаты выполнения двух вариантов кода будут идентичными. Понятно, что первый вариант использовать проще и&nbsp;быстрее, если нам нужно выполнить всего один константный запрос. Второй&nbsp;же вариант предпочтительнее, когда надо формировать запрос на&nbsp;лету. Например, если координаты нам ввел пользователь или мы&nbsp;получили&nbsp;их, например, в&nbsp;ответе геокодера.</p>
</section>
<section class="material__chapter">
<h2 id="3">Поисковое приложение</h2>
<p>Давайте напишем простое поисковое приложение. Пользователь печатает в&nbsp;командной строке запрос, а&nbsp;наша задача состоит в&nbsp;том, чтобы найти координаты запрошенного объекта и&nbsp;показать его на&nbsp;карте, выбрав соответствующий масштаб и&nbsp;позицию карты.</p>
<p>Часть кода, которая выполняет запросы к&nbsp;API, может выглядеть так:</p>
<pre><code class="language-python">import sys
from io import BytesIO
# Этот класс поможет нам сделать картинку из потока байт

import requests
from PIL import Image

# Пусть наше приложение предполагает запуск:
# python search.py Москва, ул. Ак. Королева, 12
# Тогда запрос к геокодеру формируется следующим образом:
toponym_to_find = " ".join(sys.argv[1:])

geocoder_api_server = "http://geocode-maps.yandex.ru/1.x/"

geocoder_params = {
    "apikey": "40d1649f-0493-4b70-98ba-98533de7710b",
    "geocode": toponym_to_find,
    "format": "json"}

response = requests.get(geocoder_api_server, params=geocoder_params)

if not response:
    # обработка ошибочной ситуации
    pass

# Преобразуем ответ в json-объект
json_response = response.json()
# Получаем первый топоним из ответа геокодера.
toponym = json_response["response"]["GeoObjectCollection"][
    "featureMember"][0]["GeoObject"]
# Координаты центра топонима:
toponym_coodrinates = toponym["Point"]["pos"]
# Долгота и широта:
toponym_longitude, toponym_lattitude = toponym_coodrinates.split(" ")

delta = "0.005"

# Собираем параметры для запроса к StaticMapsAPI:
map_params = {
    "ll": ",".join([toponym_longitude, toponym_lattitude]),
    "spn": ",".join([delta, delta]),
    "l": "map"
}

map_api_server = "http://static-maps.yandex.ru/1.x/"
# ... и выполняем запрос
response = requests.get(map_api_server, params=map_params)

Image.open(BytesIO(
    response.content)).show()
# Создадим картинку
# и тут же ее покажем встроенным просмотрщиком операционной системы
</code></pre>
</section>
<section class="material__chapter">
<h2 id="4">API Поиска по&nbsp;организациям</h2>
<p>Мы&nbsp;рассмотрели две части Yandex.Maps.API из&nbsp;трех. Давайте познакомимся и&nbsp;с&nbsp;третьей, Поиском по&nbsp;организациям. Или Адресным справочником.</p>
<p>Страница API: <a class="material__link" href="https://tech.yandex.ru/maps/geosearch/" target="_blank" rel="noopener noreferrer">https://tech.yandex.ru/maps/geosearch/</a></p>
<p>Прочтите описание/соглашение и&nbsp;найдите отличие от&nbsp;того, с&nbsp;чем нам приходилось работать раньше.</p>
<p>Для этого API нужен ключ. Для задач учебного курса ключ с&nbsp;необходимыми правами доступа получен заранее (dda3ddba-c9ea-4ead-9010-f43fbc15c6e3). Этот ключ позволяет выполнить лимитированное число запросов, поэтому пользоваться им&nbsp;разрешается только при решении задач этого курса. После курса ключ будет деактивирован, и&nbsp;запросы с&nbsp;ним перестанут работать. Если&nbsp;же для своих проектов вам понадобится доступ к&nbsp;API поиска по&nbsp;организациям, необходимо получить ключ самостоятельно. Для этого нужно заполнить форму, указав данные для связи, а&nbsp;также сайт, на&nbsp;котором предполагается использовать данное API. Мы&nbsp;говорили о&nbsp;том, что по&nbsp;условиям результаты надо обязательно использовать на&nbsp;сайте&nbsp;&mdash; обратите на&nbsp;это внимание. Исключение сделано только для наших учебных проектов.</p>
<p><em>Ключ для сервиса можно бесплатно получить по&nbsp;адресу:</em> <a class="material__link" href="https://developer.tech.yandex.ru/services/" target="_blank" rel="noopener noreferrer">https://developer.tech.yandex.ru/services/</a></p>
<p>Прочитайте о&nbsp;возможностях API поиска по&nbsp;организациям.</p>
<p>Формат диалога с&nbsp;Поиском по&nbsp;организациям похож на&nbsp;формат геокодера. Давайте найдем ближайшую аптеку к&nbsp;вашему дому. Будет похоже на&nbsp;написанную раньше программу поиска объекта по&nbsp;адресу.</p>
<p>Формат запроса описан на&nbsp;<a class="material__link" href="https://tech.yandex.ru/maps/doc/geosearch/concepts/request-docpage/" target="_blank" rel="noopener noreferrer">странице</a>.</p>
<pre><code class="language-python">search_api_server = "https://search-maps.yandex.ru/v1/"
api_key = "..."

address_ll = "37.588392,55.734036"

search_params = {
    "apikey": api_key,
    "text": "аптека",
    "lang": "ru_RU",
    "ll": address_ll,
    "type": "biz"
}

response = requests.get(search_api_server, params=search_params)
if not response:
    #...
    pass
</code></pre>
<p>Формат ответа смотрите на&nbsp;странице: <a class="material__link" href="https://tech.yandex.ru/maps/doc/geosearch/concepts/response_structure_business-docpage/" target="_blank" rel="noopener noreferrer">https://tech.yandex.ru/maps/doc/geosearch/concepts/response_structure_business-docpage/</a></p>
<p>Продолжим разбор примера:</p>
<pre><code class="language-python"># Преобразуем ответ в json-объект
json_response = response.json()

# Получаем первую найденную организацию.
organization = json_response["features"][0]
# Название организации.
org_name = organization["properties"]["CompanyMetaData"]["name"]
# Адрес организации.
org_address = organization["properties"]["CompanyMetaData"]["address"]

# Получаем координаты ответа.
point = organization["geometry"]["coordinates"]
org_point = "{0},{1}".format(point[0], point[1])
delta = "0.005"

# Собираем параметры для запроса к StaticMapsAPI:
map_params = {
    # позиционируем карту центром на наш исходный адрес
    "ll": address_ll,
    "spn": ",".join([delta, delta]),
    "l": "map",
    # добавим точку, чтобы указать найденную аптеку
    "pt": "{0},pm2dgl".format(org_point)
}

map_api_server = "http://static-maps.yandex.ru/1.x/"
# ... и выполняем запрос
response = requests.get(map_api_server, params=map_params)

</code></pre>
</section>
<section class="material__chapter">
<h2 id="5">Еще немного о&nbsp;возможностях requests</h2>
<p>Библиотека requests прекрасно умеет работать не&nbsp;только со&nbsp;строками и&nbsp;числами, но&nbsp;и&nbsp;преобразовывать в&nbsp;аргументы запроса и&nbsp;более сложные типы, например, списки.</p>
<pre><code class="language-python">params = {'list_param': ['value1', 'value2']}
response = requests.get('адрес_сайта', params=params)
</code></pre>
<p>Списки преобразуются в&nbsp;запросе вот к&nbsp;такому виду:</p>
<pre><code>адрес_сайта?list_param=value1&amp;list_param=value2
</code></pre>
<p>Посмотреть получившийся запрос можно с&nbsp;помощью атрибута <var>url</var>:</p>
<pre><code class="language-python">print(response.url)
</code></pre>
<p>Кроме того, можно влиять на&nbsp;служебную информацию, которая передается вместе с&nbsp;запросом в&nbsp;заголовках запроса. На&nbsp;некоторых сервисах код доступа к&nbsp;API передается именно в&nbsp;заголовке, или можно притвориться каким-нибудь браузером, переопределив значение <var>user-agent</var> запроса. Подробнее про стандартные HTTP заголовки можно почитать <a class="material__link" href="https://ru.wikipedia.org/wiki/Список_заголовков_HTTP" target="_blank" rel="noopener noreferrer">тут</a>.</p>
<p>Задать заголовки можно с&nbsp;помощью параметра <var>headers</var>, в&nbsp;который передается словарь из&nbsp;заголовков и&nbsp;их&nbsp;значений.</p>
<pre><code class="language-python">headers = {'user-agent': 'yandexlyceum/1.1.1'}
response = requests.get(url, headers=headers)
</code></pre>
<p>Это далеко не&nbsp;все возможности requests, про некоторые из&nbsp;оставшихся мы&nbsp;еще поговорим в&nbsp;курсе далее.</p>
</section></article>
						</section>
					</div>
				</main>
			</div>
		</div>
<footer class="footer">
	<div class="footer__controls">
		<a rel="noopener noreferrer" target="_blank" class="footer__help-link"
		   href="https://yandex.ru/legal/lms_termsofuse/">Terms of use</a>
	</div>
	<div class="footer__copyright">
		<div>
			<div class="Markdown">
				<div class="paragraph">Generated by <a rel="noopener noreferrer" target="_blank"
				                                       class="footer__help-link"
				                                       href="https://github.com/rodion-gudz/YandexLyceumDocs">Yandex Lyceum Docs</a>
				</div>
			</div>
		</div>
	</div>
</footer>	</div>
	<script src="/js/prism.js"></script>
</body>
</html>